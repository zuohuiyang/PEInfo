# PRD：PEInfo「字符串提取（BinText-like）」功能

## 1. 背景与问题
在逆向分析、应急响应、恶意样本初筛中，“从二进制中快速提取可读字符串（strings）”是高频需求。现有 PEInfo 侧重 PE 结构与签名/哈希信息，但缺少类似 BinText 的“字符串扫描 + 搜索/过滤 + 导出”的能力，导致用户需要额外工具来完成同一工作流。

本需求旨在把 BinText 的核心体验（快速扫、可搜索、可导出、能定位偏移/地址）集成到 PEInfo 中，并与现有报告体系（text/json）及 GUI Tab 统一。

## 2. 目标（Goals）
- 在 **GUI** 中提供字符串扫描能力（ASCII + UTF-16LE），支持最小长度、过滤、范围选择、导出。
- 每条字符串可追溯到 **File Offset**，并尽可能给出 **RVA/VA（PE 映射地址）**，便于定位。
- 扫描性能可接受：对 100MB 文件在常见 PC 上秒级完成（详见性能指标）。
- 输出格式与现有报告体系一致：支持 text/json、支持写文件、便于脚本化。

## 3. 非目标（Non-goals）
- 不做反汇编、反混淆、解密字符串还原（例如 XOR/RC4/自定义编码）。
- 不做“运行时内存扫描”（仅对磁盘文件扫描；PE 映射地址仅为静态换算）。
- 不做 OCR、资源字符串表深度解析（如需可作为后续迭代：资源字符串表与版本信息提取）。

## 4. 用户画像与场景
- 安全分析师：快速查看样本中的 URL、路径、命令行、可疑域名、mutex 等。
- 逆向工程师：定位导入/错误信息/日志 tag，跳转到对应 RVA/VA 进一步分析。
- 开发/运维：排查发布包中是否包含敏感字符串（API Key 片段、内部域名等）。

## 5. 关键体验（用户故事）
1. 作为用户，我希望拖入一个 EXE/DLL 后立即看到字符串列表，并可搜索 `http`、`.pdb`、`powershell` 等关键字。
2. 我希望双击某一条字符串能快速复制其偏移与内容，或在 GUI 中高亮显示并提供“复制行/复制文本”。
3. 我希望导出为 JSON 便于二次处理，也能导出为纯文本方便粘贴到工单。
4. 我希望能限制扫描范围（仅扫某些节，如 `.rdata`），减少噪声与耗时。

## 6. 功能需求

### 6.1 扫描类型
- **ASCII**：连续的可打印字符序列（默认字符集：0x20-0x7E，支持可选包含 `\t\r\n`）。
- **UTF-16LE**：形如 `A\0B\0C\0` 的可打印字符序列（同样支持可选包含空白控制符）。
- 支持输出条目包含字段：
  - `type`：`ascii` / `utf16le`
  - `text`：字符串内容（必要时转义控制字符）
  - `length`：字符长度（按可见字符计）
  - `byteLength`：原始字节长度
  - `fileOffset`：文件偏移（十进制与十六进制展示策略见输出）
  - `rva`（可选）：若可映射到某节则给出
  - `va`（可选）：若可映射到某节且 ImageBase 可得则给出
  - `section`（可选）：`.text/.rdata/...`（若可映射）

### 6.2 扫描范围
默认扫描“整个文件”。同时支持：
- 范围：全文件（默认；适用于任意二进制）
- 范围：PE 各节（Raw）（需要 PE 解析成功）
- 范围：PE Headers（DOS/NT/SectionHeaders 所在 Raw 范围；需要 PE 解析成功）
- 范围：Overlay（文件末尾附加数据；若存在）
- 节白名单：`.rdata,.data`（与“范围=PE 各节（Raw）”联动）
- 最大扫描字节数：N（从头开始），用于快速预览

### 6.3 过滤与去噪
- 最小长度：N（默认：ASCII=4，UTF-16LE=4）
- 最大长度：N（默认：4096，超过截断并标记）
- 包含子串：substr（仅保留包含子串的结果；大小写敏感可配置）
- 正则过滤：pattern（可选增强；默认不启用，避免引入复杂依赖）
- 去重：按 text 去重（保留最早出现的一条或全部偏移可选）
- 排序：offset/length（默认 offset）

### 6.4 导出
- text：一行一条，默认包含 `fileOffset` + `rva/va` + `type` + `text`
- json：结构化数组，字段见 6.1
- GUI：支持“导出 Text / 导出 JSON”，与现有工具栏一致；支持“复制选中/复制全部”。

## 7. CLI 交互设计

本版本不提供 CLI 入口；所有字符串扫描能力仅在 GUI 中提供。

## 8. GUI 交互设计

### 8.1 新增 Tab：Strings
在现有 Tabs 中新增：`[Strings]`。

### 8.2 线框图（简单）
```
┌───────────────────────────────────────────────────────────────────────────────┐
│ Strings   搜索：[ http ]  类型：[All▼]  最小长度：[4]  范围：[全文件▼]         │
├───────────────────────────────────────────────────────────────────────────────┤
│ Offset      Section   Type     Len   Text                                    │
│ 0x0012A3B0  .rdata    ascii    12    http://example.com                       │
│ 0x0012A420  .rdata    utf16le  18    C:\Windows\System32                      │
│ ...                                                                           │
├───────────────────────────────────────────────────────────────────────────────┤
│ 选中详情：Offset=0x0012A3B0  RVA=0x0008C3B0  VA=0x14008C3B0  [复制详情]         │
├───────────────────────────────────────────────────────────────────────────────┤
│ 右键：复制行 / 复制文本 / 复制偏移 / 导出选中                                 │
└───────────────────────────────────────────────────────────────────────────────┘
```

### 8.3 交互要点
- 不提供“刷新”按钮：打开/拖拽文件后自动扫描；当用户改变会影响扫描结果的设置（类型、最小长度、范围、节白名单等）时自动重新扫描，并在状态栏展示进度/耗时。
- 搜索框仅做本地即时过滤（不触发重新扫描）。
- 双击条目：默认复制 `Text`（或可配置为打开“复制包含偏移的行”）。
- 状态栏显示：扫描进度/耗时/结果条数；扫描中 UI 不冻结。

### 8.4 “范围”下拉建议选项
- 全文件：对任意二进制可用
- PE：全部节（Raw）：仅扫描 PE Sections 的 Raw 数据范围
- PE：仅头部（Headers）：便于发现编译器/打包器标记、DOS Stub 文本等
- PE：选择节…：多选 `.rdata/.data/.text/.rsrc` 等
- Overlay（附加数据）：仅扫描文件末尾附加区（若存在）

## 9. 简单流程图
```mermaid
flowchart LR
  A[选择文件/拖拽文件] --> B[读取文件字节流]
  B --> C{扫描模式}
  C -->|ASCII| D[提取可打印序列]
  C -->|UTF-16LE| E[提取宽字符序列]
  D --> F[位置映射: FileOff→RVA/VA(可选)]
  E --> F
  F --> G[过滤/去重/排序]
  G --> H[展示(UI)]
  H --> I[导出 Text/JSON]
```

## 10. 数据结构与输出格式（建议）

### 10.1 JSON（示例）
```json
{
  "strings": [
    {
      "type": "ascii",
      "text": "http://example.com",
      "length": 18,
      "byteLength": 18,
      "fileOffset": 1225648,
      "fileOffsetHex": "0x0012B2B0",
      "rvaHex": "0x0008D2B0",
      "vaHex": "0x14008D2B0",
      "section": ".rdata"
    }
  ]
}
```

### 10.2 Text（示例）
```
0x0012B2B0  rva=0x0008D2B0  va=0x14008D2B0  ascii    len=18  http://example.com
0x0012B420  rva=0x0008D420  va=0x14008D420  utf16le  len=14  C:\Windows\System32
```

## 11. 性能与质量指标
- 100MB 文件全文件扫描：目标 < 2s（Release x64，常见 i7/16GB 级别机器）。
- 内存：不要求一次性加载全文件；允许分块读取与滑动窗口扫描。
- 稳定性：对任意输入（非 PE、截断文件、超大文件）不崩溃；错误可解释。

## 12. 边界条件与错误处理
- 文件无法读取/被占用：提示具体原因。
- 非 PE 文件：仍允许全文件 strings 扫描（范围=全文件），但不提供 rva/va/section。
- PE 解析失败但文件可读：strings 扫描仍可进行；仅映射信息缺失。
- UTF-16LE 识别：避免误报（例如要求 0x00 间隔、最小长度、可打印比例阈值）。

## 13. 验收标准（Acceptance Criteria）
- GUI：新增 Strings Tab；可搜索过滤；可导出 Text/JSON；复制功能可用。
- 映射：对 PE 文件，至少能为位于节 Raw 数据范围内的条目给出 RVA/VA（若可映射）。
- 性能：对常见系统文件（notepad.exe 等）扫描耗时可接受，UI 不冻结。

## 14. 测试策略（建议）
- 单元测试：字符串扫描器（ASCII/UTF-16LE、最小长度、边界跨块、截断、去重）。
- 回归测试：现有 PE 报告功能输出不变（默认不开启 strings）。
- 真实样本：系统文件 + 随机二进制 + 含大量宽字符资源的样本。
